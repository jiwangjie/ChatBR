{"id": "151673", "title": "Bug 151673Incorrect weaving of after returning when 'input' bytecode is of a strange form", "description": "Bug 151673Incorrect weaving of after returning when 'input' bytecode is of a strange form We have had a user report a problem where after advice being woven into a particular method is producing code that does not verify.The problem occurs if the bytecode being input to the weaving process includes a subroutine that contains the return from the method.Here is the problematic snippet produced by some unknown compiler:200:invokespecial17; //Method com/MyException. \"<init\":(Ljava/lang/String;)V203:athrow204:aload3205:astore6207:jsr234210:aload6212:areturn213:astore4215:aload4217:invokevirtual79; //Method java/lang/Throwable.printStackTrace:()V220:jsr234223:goto238226:astore7228:jsr234231:aload7233:athrow234:astore8236:aload3237:areturn238:returnException table:fromtotarget type2213213Class javax/ejb/FinderException2226226anysee the jsr's jump to 234, but before the subroutine return at 238 there is an areturn out of the method (this method returns a String).After weaving we get something like this:200:invokespecial17; //Method com/MyException. \"<init\":(Ljava/lang/String;)V203:athrow204:aload3205:astore6207:jsr238210:aload6212:astore9214:goto248217:astore4219:aload4221:invokevirtual79; //Method java/lang/Throwable.printStackTrace:()V224:jsr238227:goto246230:astore7232:jsr238235:aload7237:athrow238:astore8240:aload3241:astore9243:goto248246:astore9248:invokestatic299; //Method After.aspectOf:()LAfter;251:invokevirtual302; //Method After.ajc$afterReturning$After$1$26d6d4a7:()V254:aload9256:returnsee how the areturn has been lostthis code will blow up with a verify error (the string is on the stack, we just ignore it and 'return' normally) ", "OB": "", "EB": "", "SR": ""}