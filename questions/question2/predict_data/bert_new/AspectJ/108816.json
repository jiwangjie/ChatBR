{"id": "108816", "title": "Bug 108816AspectJ 1.5.0 Development Compiler Chokes on Advice with Cflow", "description": "The following is a valid AspectJ program, that should compile and run withoutinfinite recursion. It does so with AspectJ 1.2.1. AspectJ 1.5.0 Development(but not M3a) chokes on it.Sample Code:aspect BadAdvice {after(Object controller) returning (Object foo):cflow(adviceexecution() && args(controller, ..) && this(BadAdvice)) &&call(Bar+.new(..)) {}Object around(Object controller) : call( whoKnows()) && target(controller){return new Bar();}public static void main(String args[]) {(new Bar()).whoKnows();}}class Bar {void whoKnows() {}}Now look at the horrid output:C:\\devel\\scratch\\recurseajc BadAdvice.ajtrouble in:public class BadAdvice extends java.lang.Object:private static Throwable ajc$initFailureCausepublic static final BadAdvice ajc$perSingletonInstancepublic static final org.aspectj.runtime.internal.CFlowStack ajc$cflowStack$0static void <clinit():INVOKESTATIC BadAdvice.ajc$preClinit ()Vstaticinitialization(void BadAdvice.<clinit())| catch java.lang.ThrowableE0| |INVOKESTATIC BadAdvice.ajc$postClinit ()V(line 1)| catch java.lang.ThrowableE0|GOTO L0|E0: ASTORE0|ALOAD0|PUTSTATIC BadAdvice.ajc$initFailureCause Ljava/lang/Throwable;|L0: RETURNstaticinitialization(void BadAdvice.<clinit())end static void <clinit()void <init():ALOAD0// BadAdvice this(line 1)INVOKESPECIAL java.lang.Object.<init ()Vconstructorexecution(void BadAdvice.<init())|RETURNconstructorexecution(void BadAdvice.<init())end void <init()public void ajc$afterReturning$BadAdvice$1$97dc015a(Object, Object)AdviceAttribute(afterReturning, (cflow((execution( ) && (args(BindingTypePattern(java.lang.Object, 0), ..) && this(BadAdvice)))) && call(Bar+.new(..))), 1, 24):ALOAD1ASTORE3ALOAD2ASTORE 4adviceexecution(void BadAdvice.ajc$afterReturning$BadAdvice$1$97dc015a(java.lang.Object, java.lang.Object))|BIPUSH 1|ANEWARRAY java.lang.Object|ASTORE 6|ALOAD 6|BIPUSH 0|ALOAD3|AASTORE|GETSTATIC BadAdvice.ajc$cflowStack$0 Lorg/aspectj/runtime/internal/CFlowStack;|ALOAD 6|INVOKEVIRTUAL org.aspectj.runtime.internal.CFlowStack.push ([Ljava/lang/Object;)V| catch java.lang.ThrowableE0| |GOTO L0(line 4)| catch java.lang.ThrowableE0|E0: ASTORE 7|GETSTATIC BadAdvice.ajc$cflowStack$0 Lorg/aspectj/runtime/internal/CFlowStack;|INVOKEVIRTUAL org.aspectj.runtime.internal.CFlowStack.pop ()V|ALOAD 7|ATHROW|L0: GETSTATIC BadAdvice.ajc$cflowStack$0 Lorg/aspectj/runtime/internal/CFlowStack;|INVOKEVIRTUAL org.aspectj.runtime.internal.CFlowStack.pop ()V|RETURNadviceexecution(void BadAdvice.ajc$afterReturning$BadAdvice$1$97dc015a(java.lang.Object, java.lang.Object))end public void ajc$afterReturning$BadAdvice$1$97dc015a(Object, Object)public Object ajc$around$BadAdvice$2$ef382b2d(Object, org.aspectj.runtime.internal.AroundClosure)AdviceAttribute(around, (call( whoKnows()) && target(BindingTypePattern(java.lang.Object, 0))), 1, 196):adviceexecution(java.lang.Object BadAdvice.ajc$around$BadAdvice$2$ef382b2d(java.lang.Object, org.aspectj.runtime.internal.AroundClosure))| constructorcall(void Bar.<init())| |NEW Bar| |DUP| |INVOKESPECIAL Bar.<init ()V(line 6)| |DUP| |ASTORE3| |GETSTATIC BadAdvice.ajc$cflowStack$0 Lorg/aspectj/runtime/internal/CFlowStack;| |INVOKEVIRTUAL org.aspectj.runtime.internal.CFlowStack.isValid ()Z| |IFEQ L0| |INVOKESTATIC BadAdvice.aspectOf ()LBadAdvice;| |GETSTATIC BadAdvice.ajc$cflowStack$0 Lorg/aspectj/runtime/internal/CFlowStack;| |BIPUSH 0| |INVOKEVIRTUAL org.aspectj.runtime.internal.CFlowStack.get (I)Ljava/lang/Object;| |ALOAD3| |INVOKEVIRTUAL BadAdvice.ajc$afterReturning$BadAdvice$1$97dc015a (Ljava/lang/Object;Ljava/lang/Object;)V| |L0: NOP| constructorcall(void Bar.<init())|ARETURNadviceexecution(java.lang.Object BadAdvice.ajc$around$BadAdvice$2$ef382b2d(java.lang.Object, org.aspectj.runtime.internal.AroundClosure))end public Object ajc$around$BadAdvice$2$ef382b2d(Object, org.aspectj.runtime.internal.AroundClosure)static Object ajc$around$BadAdvice$2$ef382b2dproceed(Object, org.aspectj.runtime.internal.AroundClosure) throws java.lang.Throwableorg.aspectj.weaver.AjAttribute$AjSynthetic@3feb61:ALOAD1ICONST1ANEWARRAY java.lang.ObjectDUPICONST0ALOAD0// BadAdvice thisAASTOREINVOKEVIRTUAL org.aspectj.runtime.internal.AroundClosure.run ([Ljava/lang/Object;)Ljava/lang/Object;CHECKCAST java.lang.ObjectARETURNend static Object ajc$around$BadAdvice$2$ef382b2dproceed(Object, org.aspectj.runtime.internal.AroundClosure) throws java.lang.Throwablepublic static BadAdvice aspectOf()org.aspectj.weaver.AjAttribute$AjSynthetic@3ff616:GETSTATIC BadAdvice.ajc$perSingletonInstance LBadAdvice;IFNONNULL L0NEW org.aspectj.lang.NoAspectBoundExceptionDUPLDC \"BadAdvice\"GETSTATIC BadAdvice.ajc$initFailureCause Ljava/lang/Throwable;INVOKESPECIAL org.aspectj.lang.NoAspectBoundException.<init (Ljava/lang/String;Ljava/lang/Throwable;)VATHROWL0: GETSTATIC BadAdvice.ajc$perSingletonInstance LBadAdvice;ARETURNend public static BadAdvice aspectOf()public static boolean hasAspect()org.aspectj.weaver.AjAttribute$AjSynthetic@400021:GETSTATIC BadAdvice.ajc$perSingletonInstance LBadAdvice;IFNULL L0ICONST1IRETURNL0: ICONST0IRETURNend public static boolean hasAspect()private static void ajc$postClinit()org.aspectj.weaver.AjAttribute$AjSynthetic@400662:NEW BadAdviceDUPINVOKESPECIAL BadAdvice.<init ()VPUTSTATIC BadAdvice.ajc$perSingletonInstance LBadAdvice;RETURNend private static void ajc$postClinit()static void ajc$preClinit():NEW org.aspectj.runtime.internal.CFlowStackDUPINVOKESPECIAL org.aspectj.runtime.internal.CFlowStack.<init ()VPUTSTATIC BadAdvice.ajc$cflowStack$0 Lorg/aspectj/runtime/internal/CFlowStack;RETURNend static void ajc$preClinit()end public class BadAdvicejava.lang.NullPointerExceptionat org.aspectj.weaver.bcel.BcelVar.appendConvertableArrayStore(BcelVar.java:96)at org.aspectj.weaver.bcel.BcelShadow.weaveCflowEntry(BcelShadow.java:1836)at org.aspectj.weaver.bcel.BcelAdvice.implementOn(BcelAdvice.java:200)at org.aspectj.weaver.Shadow.implementMungers(Shadow.java:511)at org.aspectj.weaver.Shadow.implement(Shadow.java:388)at org.aspectj.weaver.bcel.BcelClassWeaver.implement(BcelClassWeaver.java:1757)at org.aspectj.weaver.bcel.BcelClassWeaver.weave(BcelClassWeaver.java:393)at org.aspectj.weaver.bcel.BcelClassWeaver.weave(BcelClassWeaver.java:96)at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:1415)at org.aspectj.weaver.bcel.BcelWeaver.weaveWithoutDump(BcelWeaver.java:1380)at org.aspectj.weaver.bcel.BcelWeaver.weaveAndNotify(BcelWeaver.java:1157)at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:989)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.weave(AjCompilerAdapter.java:286)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.afterCompiling(AjCompilerAdapter.java:165)at org.aspectj.ajdt.internal.compiler.CompilerAdapter.ajc$afterReturning$orgaspectjajdtinternalcompilerCompilerAdapter$2$f9cc9ca0(CompilerAdapter.aj:70)at org.aspectj.org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:367)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.performCompilation(AjBuildManager.java:728)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.doBuild(AjBuildManager.java:206)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.batchBuild(AjBuildManager.java:140)at org.aspectj.ajdt.ajc.AjdtCommand.doCommand(AjdtCommand.java:112)at org.aspectj.ajdt.ajc.AjdtCommand.runCommand(AjdtCommand.java:60)at org.aspectj.tools.ajc.Main.run(Main.java:324)at org.aspectj.tools.ajc.Main.runMain(Main.java:238)at org.aspectj.tools.ajc.Main.main(Main.java:82)ABORTException thrown from AspectJ DEVELOPMENTThis might be logged as a bug alreadyfind current bugs athttp://bugs.eclipse.org/bugs/buglist.cgi?product=AspectJ&component=CompilerBugs for exceptions thrown have titles File:line from the top stack,e.g., \"SomeFile.java:243\"If you don't find the exception below in a bug, please add a new bugat http://bugs.eclipse.org/bugs/enterbug.cgi?product=AspectJTo make the bug a priority, please include a test programthat can reproduce this exception.nulljava.lang.NullPointerExceptionat org.aspectj.weaver.bcel.BcelVar.appendConvertableArrayStore(BcelVar.java:96)at org.aspectj.weaver.bcel.BcelShadow.weaveCflowEntry(BcelShadow.java:1836)at org.aspectj.weaver.bcel.BcelAdvice.implementOn(BcelAdvice.java:200)at org.aspectj.weaver.Shadow.implementMungers(Shadow.java:511)at org.aspectj.weaver.Shadow.implement(Shadow.java:388)at org.aspectj.weaver.bcel.BcelClassWeaver.implement(BcelClassWeaver.java:1757)at org.aspectj.weaver.bcel.BcelClassWeaver.weave(BcelClassWeaver.java:393)at org.aspectj.weaver.bcel.BcelClassWeaver.weave(BcelClassWeaver.java:96)at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:1415)at org.aspectj.weaver.bcel.BcelWeaver.weaveWithoutDump(BcelWeaver.java:1380)at org.aspectj.weaver.bcel.BcelWeaver.weaveAndNotify(BcelWeaver.java:1157)at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:989)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.weave(AjCompilerAdapter.java:286)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.afterCompiling(AjCompilerAdapter.java:165)at org.aspectj.ajdt.internal.compiler.CompilerAdapter.ajc$afterReturning$orgaspectjajdtinternalcompilerCompilerAdapter$2$f9cc9ca0(CompilerAdapter.aj:70)at org.aspectj.org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:367)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.performCompilation(AjBuildManager.java:728)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.doBuild(AjBuildManager.java:206)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.batchBuild(AjBuildManager.java:140)at org.aspectj.ajdt.ajc.AjdtCommand.doCommand(AjdtCommand.java:112)at org.aspectj.ajdt.ajc.AjdtCommand.runCommand(AjdtCommand.java:60)at org.aspectj.tools.ajc.Main.run(Main.java:324)at org.aspectj.tools.ajc.Main.runMain(Main.java:238)at org.aspectj.tools.ajc.Main.main(Main.java:82)1 fail|abortNote: there isn't ever a call to construct a Bar in the first advice, so itshouldn't actually be selfadvising at runtime, and even though the advice doesitself match the cflow expression, it should just push an entry on the cflowstack.By the way, this would be a great place to have a name for advice, so I couldexclude this one advice from advising itself. ", "OB": "Bug 108816AspectJ 1.5.0 Development Compiler Chokes on Advice with Cflow ", "EB": "", "SR": ""}