{"id": "59208", "title": "Bug 59208Weaver fails in BCELfor large classes", "description": " Bug 59208Weaver fails in BCELfor large classes This problem was first observed when weaving large binary legacy classes withthe ajc 1.2 rc1 candidate.", "OB": " It turns out that BCEL fails with different errormessages dependent on whether we are doing a binary weave or a straight ajccompile.", "EB": "", "SR": " In the latter case, the error message is rather confusing.To reproduce:1. Compile and run the following code to produce Foo.java// File FooProducer.javapublic class FooProducer{public static final int NMETHODS = 50;public static final int NSTATEMENTS = Short.MAXVALUE/(2NMETHODS);public static void main(String[] args) {System.out.println(\"public class Foo {\");System.out.println(\"static java.util.Set hs = new java.util.HashSet();\");for (int i = 0; i < NMETHODS; i++) {System.out.println(\"public void test\" + i + \"() { \");for (int j = 0; j < NSTATEMENTS; j++) {System.out.println(\"hs.add(new Object());\");}System.out.println(\"}\");}System.out.println(\"}\");}}// End of FooProducer.java2. Create the following Aspect:// File a.ajaspect a{ boolean around() : (target(java.util.HashSet) && call(boolean add(..) ) ){return false;}}// End of a.aj 3.astraight compile and weave:ajc sourceroots .ABORTException thrown from AspectJ 1.2rc1This might be logged as a bug alreadyfind current bugs athttp://bugs.eclipse.org/bugs/buglist.cgi?product=AspectJ&component=CompilerBugs for exceptions thrown have titles File:line from the top stack,e.g., \"SomeFile.java:243\"If you don't find the exception below in a bug, please add a new bugat http://bugs.eclipse.org/bugs/enterbug.cgi?product=AspectJTo make the bug a priority, please include a test programthat can reproduce this exception.Expected class `CONSTANTUtf8' at index 25700 and got CONSTANTNameAndType[12](nameindex = 25696, signatureindex = 81)Expected class `CONSTANTUtf8' at index 25700 and got CONSTANTNameAndType[12](nameindex = 25696, signatureindex = 81)org.apache.bcel.classfile.ClassFormatException: Expected class `CONSTANTUtf8'at index 25700 and got CONSTANTNameAndType[12](nameindex = 25696,signatureindex = 81)at org.apache.bcel.classfile.ConstantPool.getConstant(ConstantPool.java:271)at org.apache.bcel.classfile.Attribute.readAttribute(Attribute.java:163)at org.apache.bcel.classfile.FieldOrMethod.<init(FieldOrMethod.java:98)at org.apache.bcel.classfile.Field.<init(Field.java:83)at org.apache.bcel.classfile.ClassParser.readFields(ClassParser.java:270)at org.apache.bcel.classfile.ClassParser.parse(ClassParser.java:172)at org.aspectj.weaver.bcel.Utility.makeJavaClass(Utility.java:358)at org.aspectj.weaver.bcel.UnwovenClassFile.getJavaClass(UnwovenClassFile.java:63)at org.aspectj.weaver.bcel.UnwovenClassFile.getClassName(UnwovenClassFile.java:147)at org.aspectj.ajdt.internal.compiler.WeaverAdapter.acceptResult(WeaverAdapter.java:177)at org.aspectj.weaver.bcel.BcelWeaver.weaveAndNotify(BcelWeaver.java:621)at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:563)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.weave(AjCompilerAdapter.java:239)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.afterCompiling(AjCompilerAdapter.java:114)at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:376)atorg.aspectj.ajdt.internal.core.builder.AjBuildManager.performCompilation(AjBuildManager.java:600)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.doBuild(AjBuildManager.java:160)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.batchBuild(AjBuildManager.java:94)at org.aspectj.ajdt.ajc.AjdtCommand.doCommand(AjdtCommand.java:102)at org.aspectj.ajdt.ajc.AjdtCommand.runCommand(AjdtCommand.java:53)at org.aspectj.tools.ajc.Main.run(Main.java:280)at org.aspectj.tools.ajc.Main.runMain(Main.java:217)at org.aspectj.tools.ajc.Main.main(Main.java:79)1 fail|abortSignal 127 3bbinary weave ajc noweave outjar test.jar a.aj javac d classes Foo.javaajcaspectpath test.jar inpath classesABORTException thrown from AspectJ 1.2rc1This might be logged as a bug alreadyfind current bugs athttp://bugs.eclipse.org/bugs/buglist.cgi?product=AspectJ&component=CompilerBugs for exceptions thrown have titles File:line from the top stack,e.g., \"SomeFile.java:243\"If you don't find the exception below in a bug, please add a new bugat http://bugs.eclipse.org/bugs/enterbug.cgi?product=AspectJTo make the bug a priority, please include a test programthat can reproduce this exception.Class can't be both final and abstractClass can't be both final and abstractorg.apache.bcel.classfile.ClassFormatException: Class can't be both final andabstractat org.apache.bcel.classfile.ClassParser.readClassInfo(ClassParser.java:242)at org.apache.bcel.classfile.ClassParser.parse(ClassParser.java:165)at org.aspectj.weaver.bcel.Utility.makeJavaClass(Utility.java:358)at org.aspectj.weaver.bcel.UnwovenClassFile.getJavaClass(UnwovenClassFile.java:63)at org.aspectj.weaver.bcel.UnwovenClassFile.getClassName(UnwovenClassFile.java:147)at org.aspectj.ajdt.internal.compiler.WeaverAdapter.acceptResult(WeaverAdapter.java:177)at org.aspectj.weaver.bcel.BcelWeaver.weaveAndNotify(BcelWeaver.java:621)at org.aspectj.weaver.bcel.BcelWeaver.weave(BcelWeaver.java:563)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.weave(AjCompilerAdapter.java:239)at org.aspectj.ajdt.internal.compiler.AjCompilerAdapter.afterCompiling(AjCompilerAdapter.java:114)at org.eclipse.jdt.internal.compiler.Compiler.compile(Compiler.java:376)atorg.aspectj.ajdt.internal.core.builder.AjBuildManager.performCompilation(AjBuildManager.java:600)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.doBuild(AjBuildManager.java:160)at org.aspectj.ajdt.internal.core.builder.AjBuildManager.batchBuild(AjBuildManager.java:94)at org.aspectj.ajdt.ajc.AjdtCommand.doCommand(AjdtCommand.java:102)at org.aspectj.ajdt.ajc.AjdtCommand.runCommand(AjdtCommand.java:53)at org.aspectj.tools.ajc.Main.run(Main.java:280)at org.aspectj.tools.ajc.Main.runMain(Main.java:217)at org.aspectj.tools.ajc.Main.main(Main.java:79)1 fail|abortSignal 127"}