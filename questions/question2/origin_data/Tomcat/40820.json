{"bug_id": "40820", "title": "Bug 40820Default JSP factory not initialized early enough", "description": "With the latest TC6 code, I'm seeing a problem that did not exist on earlier TC6drivers.Sorry that I can't put a finger on when this problem arose.I lookedinto relevant source files (like JspRuntimeContext) but haven't found the sourceof the problem.Here's the issue (a testcase will be attached).The app is very simple: it installs ServletContextListener for the purpose ofadding a custom ELResolver.It accomplishes this via:public void contextInitialized(ServletContextEvent evt) {ServletContext context = evt.getServletContext();JspApplicationContext jspContext =JspFactory.getDefaultFactory().getJspApplicationContext(context);jspContext.addELResolver(new ChipsELResolver());}The problem is that JspFactory.getDefaultFactory() is returning null; see below.Oct 4, 2006 5:32:18 PM org.apache.catalina.core.AprLifecycleListener lifecycleEventINFO: The Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: C:\\javaFor6.0BuildJDK15\\java\\jre\\bin;.;C:\\javaFor6.0BuildJDK15\\java\\bin;c:\\mantis2.1\\mantis\\bin;C:\\setupIBASE;C:\\Perl\\bin\\;C:\\WINDOWS\\system32;C:\\WINDOWS;C:\\WINDOWS\\System32\\Wbem;c:\\Python22;C:\\Program Files\\PCDoctor for Windows\\services;c:\\cvsnt2.0.4;c:\\eclipse;w:\\;w:\\bin;C:\\Program Files\\QuickTime\\QTSystem\\;C:\\Diskeeper\\;C:\\CMVC\\exe;C:\\CMVC\\exe\\bin;;C:\\CMVCDC50;C:\\CMVCDC50;C:\\CMVCDC50;Oct 4, 2006 5:32:18 PM org.apache.coyote.http11.Http11Protocol initINFO: Initializing Coyote HTTP/1.1 on http8080Oct 4, 2006 5:32:19 PM org.apache.catalina.startup.Catalina loadINFO: Initialization processed in 1234 msOct 4, 2006 5:32:19 PM org.apache.catalina.core.StandardService startINFO: Starting service CatalinaOct 4, 2006 5:32:19 PM org.apache.catalina.core.StandardEngine startINFO: Starting Servlet Engine: Apache Tomcat/6.0.0devOct 4, 2006 5:32:19 PM org.apache.catalina.core.StandardHost startINFO: XML validation disabledOct 4, 2006 5:32:19 PM org.apache.catalina.startup.HostConfig deployWARINFO: Deploying web application archive ELResolverTest.warChipsListener.contextInitializedevt= javax.servlet.ServletContextEvent[source=org.apache.catalina.core.ApplicationContextFacade@3fbe3fbe]ChipsListener.contextInitializedcontext= org.apache.catalina.core.ApplicationContextFacade@3fbe3fbeChipsListener.contextInitializedJspFactory.getDefaultFactory()= nullOct 4, 2006 5:32:20 PM org.apache.catalina.core.StandardContext startSEVERE: Error listenerStartOct 4, 2006 5:32:20 PM org.apache.catalina.core.StandardContext startSEVERE: Context [/ELResolverTest] startup failed due to previous errorsOct 4, 2006 5:32:21 PM org.apache.coyote.http11.Http11Protocol startINFO: Starting Coyote HTTP/1.1 on http8080Oct 4, 2006 5:32:21 PM org.apache.jk.common.ChannelSocket initINFO: JK: ajp13 listening on /0.0.0.0:8009Oct 4, 2006 5:32:21 PM org.apache.jk.server.JkMain startINFO: Jk running ID=0 time=0/63config=nullOct 4, 2006 5:32:21 PM org.apache.catalina.startup.Catalina startINFO: Server startup in 2657 msThis is easily reproducible when you deploy the ELResolverTest.war before theserver has started (I assume JspFactory.setDefaultFactory() hasn't been invokedat the time the listeners are being installed).If you deploy the WAR afterthe server starts, the problem does not manifest and the app works  until youstop and restart the server."}